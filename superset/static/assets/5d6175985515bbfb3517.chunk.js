"use strict";(globalThis.webpackChunksuperset=globalThis.webpackChunksuperset||[]).push([[357],{10357:(e,t,i)=>{i.r(t),i.d(t,{default:()=>V,getLayer:()=>T});var a=i(78580),o=i.n(a),s=i(67294),r=i(45697),l=i.n(r),n=i(78918),d=i(80744),h=i(38550),c=i(71435),g=i(62112),p=i(99890),u=i(98452);const m=[0,0,0,255],f={stroked:!0,filled:!0,extruded:!1,elevationScale:1,wireframe:!1,_normalize:!0,_windingOrder:"CW",lineWidthUnits:"meters",lineWidthScale:1,lineWidthMinPixels:0,lineWidthMaxPixels:Number.MAX_SAFE_INTEGER,lineJointRounded:!1,lineMiterLimit:4,getPolygon:{type:"accessor",value:e=>e.polygon},getFillColor:{type:"accessor",value:[0,0,0,255]},getLineColor:{type:"accessor",value:m},getLineWidth:{type:"accessor",value:1},getElevation:{type:"accessor",value:1e3},material:!0};class y extends n.Z{initializeState(){this.state={paths:[]},this.props.getLineDashArray&&d.Z.removed("getLineDashArray","PathStyleExtension")()}updateState({oldProps:e,props:t,changeFlags:i}){const a=i.dataChanged||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getPolygon);if(a&&Array.isArray(i.dataChanged)){const e=this.state.paths.slice(),t=i.dataChanged.map((t=>(0,u.b)({data:e,getIndex:e=>e.__source.index,dataRange:t,replace:this._getPaths(t)})));this.setState({paths:e,pathsDiff:t})}else a&&this.setState({paths:this._getPaths(),pathsDiff:null})}_getPaths(e={}){const{data:t,getPolygon:i,positionFormat:a,_normalize:o}=this.props,s=[],r="XY"===a?2:3,{startRow:l,endRow:n}=e,{iterable:d,objectInfo:c}=(0,h.jB)(t,l,n);for(const e of d){c.index++;let t=i(e,c);o&&(t=p.F(t,r));const{holeIndices:a}=t,l=t.positions||t;if(a)for(let t=0;t<=a.length;t++){const i=l.slice(a[t-1]||0,a[t]||l.length);s.push(this.getSubLayerRow({path:i},e,c.index))}else s.push(this.getSubLayerRow({path:l},e,c.index))}return s}renderLayers(){const{data:e,_dataDiff:t,stroked:i,filled:a,extruded:o,wireframe:s,_normalize:r,_windingOrder:l,elevationScale:n,transitions:d,positionFormat:h}=this.props,{lineWidthUnits:p,lineWidthScale:u,lineWidthMinPixels:f,lineWidthMaxPixels:y,lineJointRounded:_,lineMiterLimit:b,lineDashJustified:v}=this.props,{getFillColor:C,getLineColor:L,getLineWidth:S,getLineDashArray:w,getElevation:x,getPolygon:P,updateTriggers:F,material:k}=this.props,{paths:A,pathsDiff:D}=this.state,R=this.getSubLayerClass("fill",c.Z),Z=this.getSubLayerClass("stroke",g.Z),W=this.shouldRenderSubLayer("fill",A)&&new R({_dataDiff:t,extruded:o,elevationScale:n,filled:a,wireframe:s,_normalize:r,_windingOrder:l,getElevation:x,getFillColor:C,getLineColor:o&&s?L:m,material:k,transitions:d},this.getSubLayerProps({id:"fill",updateTriggers:{getPolygon:F.getPolygon,getElevation:F.getElevation,getFillColor:F.getFillColor,lineColors:o&&s,getLineColor:F.getLineColor}}),{data:e,positionFormat:h,getPolygon:P});return[!o&&W,!o&&i&&this.shouldRenderSubLayer("stroke",A)&&new Z({_dataDiff:D&&(()=>D),widthUnits:p,widthScale:u,widthMinPixels:f,widthMaxPixels:y,jointRounded:_,miterLimit:b,dashJustified:v,_pathType:"loop",transitions:d&&{getWidth:d.getLineWidth,getColor:d.getLineColor,getPath:d.getPolygon},getColor:this.getSubLayerAccessor(L),getWidth:this.getSubLayerAccessor(S),getDashArray:this.getSubLayerAccessor(w)},this.getSubLayerProps({id:"stroke",updateTriggers:{getWidth:F.getLineWidth,getColor:F.getLineColor,getDashArray:F.getLineDashArray}}),{data:A,positionFormat:h,getPath:e=>e.path}),o&&W]}}y.layerName="PolygonLayer",y.defaultProps=f;var _=i(85531),b=i(36665),v=i(1740),C=i(4065),L=i(39828),S=i(2995),w=i(45511),x=i(64106);function P(e,t,i){let{break_points:a,num_buckets:o}=e;if(!t)return[];if(void 0===a||0===a.length){const e=o?parseInt(o,10):10,[a,s]=(0,C.extent)(t,i);if(void 0===a)return[];const r=(s-a)/e,l=0===r?0:Math.max(0,Math.ceil(Math.log10(1/r))),n=s>s.toFixed(l)?1:0,d=a<a.toFixed(l)?a-1:a;return new Array(e+1+n).fill().map(((e,t)=>(d+t*r).toFixed(l)))}return a.sort(((e,t)=>parseFloat(e)-parseFloat(t)))}function F(e,t,i){let{break_points:a,num_buckets:o,linear_color_scheme:s,opacity:r}=e;const l=a||o?P({break_points:a,num_buckets:o},t,i):null,n=Array.isArray(s)?new S.Z({colors:s,id:"custom"}):(0,w.Z)().get(s);let d,h;if(null!==l){const e=l.length-1,t=e>1?n.getColors(e):[n.colors[n.colors.length-1]],i=t[0],a=t[t.length-1];t.unshift(i),t.push(a);const o=l.map((e=>parseFloat(e)));d=(0,L.Z)().domain(o).range(t),h=t=>t>l[e]||t<l[0]}else d=n.createLinearScale((0,C.extent)(t,i)),h=()=>!1;return e=>{const t=i(e),a=(0,x.hexToRGB)(d(t));return h(t)?a[3]=0:a[3]=r/100*255,a}}var k=i(52154),A=i(66911),D=i(21207);function R(e){return"geometry"in e.polygon?e.polygon.geometry.coordinates[0]:e.polygon}var Z=i(40461),W=i(11965);function T(e,t,i,a,s,r,l){var n;const d=e,h=d.fill_color_picker,c=d.stroke_color_picker;let g=[...t.data.features];if(null!=l&&l.forEach((e=>{g=g.filter((t=>e(t)))})),d.js_data_mutator){const e=(0,D.Z)(d.js_data_mutator);g=e(g)}const p=d.metric?d.metric.label||d.metric:null,u=null===d.metric?()=>[h.r,h.g,h.b,255*h.a]:F(d,g,(e=>e[p])),m=e=>{const t=u(e);return s.length>0&&!o()(s).call(s,e[d.line_column])&&(t[3]/=2),t},f=d.line_column&&d.metric&&o()(n=["json","geohash","zipcode"]).call(n,d.line_type)?function(e){return t=>{const i=e.metric.label||e.metric;return(0,W.tZ)("div",{className:"deckgl-tooltip"},t.object.name&&(0,W.tZ)(v.Z,{label:"name: ",value:`${t.object.name}`}),t.object[e.line_column]&&(0,W.tZ)(v.Z,{label:`${e.line_column}: `,value:`${t.object[e.line_column]}`}),e.metric&&(0,W.tZ)(v.Z,{label:`${i}: `,value:`${t.object[i]}`}))}}(d):void 0;return new y({id:`path-layer-${d.slice_id}`,data:g,pickable:!0,filled:d.filled,stroked:d.stroked,getPolygon:R,getFillColor:m,getLineColor:[c.r,c.g,c.b,255*c.a],getLineWidth:d.line_width,extruded:d.extruded,getElevation:e=>function(e,t){return 0===t(e)[3]?0:e.elevation}(e,m),elevationScale:d.multiplier,fp64:!0,...(0,k.N)(d,a,f,r)})}const j={formData:l().object.isRequired,payload:l().object.isRequired,setControlValue:l().func.isRequired,viewport:l().object.isRequired,onAddFilter:l().func,width:l().number.isRequired,height:l().number.isRequired},M={onAddFilter(){}};class E extends s.Component{constructor(e){super(e),this.containerRef=s.createRef(),this.setTooltip=e=>{const{current:t}=this.containerRef;t&&t.setTooltip(e)},this.state=E.getDerivedStateFromProps(e),this.getLayers=this.getLayers.bind(this),this.onSelect=this.onSelect.bind(this),this.onValuesChange=this.onValuesChange.bind(this)}static getDerivedStateFromProps(e,t){const{width:i,height:a,formData:o,payload:s}=e;if(t&&s.form_data===t.formData)return null;const r=s.data.features||[],l=r.map((e=>e.__timestamp)),n=s.form_data.time_grain_sqla||s.form_data.granularity||"P1D",{start:d,end:h,getStep:c,values:g,disabled:p}=(0,A.g)(l,n);let{viewport:u}=e;return o.autozoom&&(u=(0,Z.Z)(u,{width:i,height:a,points:r.flatMap(R)})),{start:d,end:h,getStep:c,values:g,disabled:p,viewport:u,selected:[],lastClick:0,formData:s.form_data}}onSelect(e){const{formData:t,onAddFilter:i}=this.props,a=new Date,o=a-this.state.lastClick<=250,s=[...this.state.selected];if(o)s.splice(0,s.length,e);else if(t.toggle_polygons){const t=s.indexOf(e);-1===t?s.push(e):s.splice(t,1)}else s.splice(0,1,e);this.setState({selected:s,lastClick:a}),t.table_filter&&i(t.line_column,s,!1,!0)}onValuesChange(e){this.setState({values:Array.isArray(e)?e:[e,e+this.state.getStep(e)]})}getLayers(e){if(void 0===this.props.payload.data.features)return[];const t=[];return e[0]===e[1]||e[1]===this.end?t.push((t=>t.__timestamp>=e[0]&&t.__timestamp<=e[1])):t.push((t=>t.__timestamp>=e[0]&&t.__timestamp<e[1])),[T(this.props.formData,this.props.payload,this.props.onAddFilter,this.setTooltip,this.state.selected,this.onSelect,t)]}render(){const{payload:e,formData:t,setControlValue:i}=this.props,{start:a,end:o,getStep:s,values:r,disabled:l,viewport:n}=this.state,d=t,h=d.metric?d.metric.label||d.metric:null,c=function(e,t,i){const a=P(e,t,i),o=F(e,t,i),s={};return a.slice(1).forEach(((t,i)=>{const r=`${a[i]} - ${a[i+1]}`,l=.5*(parseFloat(a[i])+parseFloat(a[i+1])),n=e.metric?e.metric.label||e.metric:null;s[r]={color:o({[n||e.metric]:l}),enabled:!0}})),s}(t,e.data.features,(e=>e[h]));return(0,W.tZ)("div",{style:{position:"relative"}},(0,W.tZ)(_.Z,{ref:this.containerRef,aggregation:!0,getLayers:this.getLayers,start:a,end:o,getStep:s,values:r,disabled:l,viewport:n,width:this.props.width,height:this.props.height,mapboxApiAccessToken:e.data.mapboxApiKey,mapStyle:t.mapbox_style,setControlValue:i,onValuesChange:this.onValuesChange,onViewportChange:this.onViewportChange},null!==t.metric&&(0,W.tZ)(b.Z,{categories:c,position:t.legend_position,format:t.legend_format})))}}E.propTypes=j,E.defaultProps=M;const V=E}}]);
//# sourceMappingURL=5d6175985515bbfb3517.chunk.js.map